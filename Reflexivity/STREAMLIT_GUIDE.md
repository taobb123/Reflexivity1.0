# Streamlit 股票回测应用使用指南

## 📋 概述

这是一个基于Streamlit构建的股票反身性模型回测应用，支持：
- 📊 从真实股票数据反推模型参数（α、γ、β）
- 🔄 实时调整参数进行回测对比
- 📈 可视化展示价格、基本面、市场预期等
- 🔬 参数敏感性分析和稳定性边界图

## 🚀 快速开始

### 1. 安装依赖

```bash
pip install -r requirements.txt
```

确保已安装以下关键依赖：
- `streamlit>=1.28.0`
- `plotly>=5.17.0`
- `akshare>=1.12.0`
- `baostock>=0.8.8`

### 2. 启动应用

```bash
streamlit run stock_backtest.py
```

应用会自动在浏览器中打开（通常是 `http://localhost:8501`）

## 📖 功能说明

### 1. 数据输入（侧边栏）

- **股票名称或代码**：输入股票名称（如"平安银行"）或代码（如"000001"）
- **回测时间范围**：选择要分析的历史数据周数（20-200周）

### 2. 参数控制

#### 使用反推参数
- 勾选"使用反推参数"：系统会从真实股票数据自动反推出最优的α、γ、β参数

#### 手动参数对比
- 勾选"同时使用手动参数对比"：可以在反推参数基础上，手动调整参数进行对比
- 调整参数滑块：
  - **α (价格权重)**：0.0 - 2.0，价格在认知中的权重
  - **γ (价格调整速度)**：0.0 - 5.0，价格向市场预期调整的速度
  - **β (基本面影响)**：0.0 - 2.0，价格对基本面的影响强度

### 3. 高级功能

- **参数敏感性分析**：展示每个参数对模型拟合效果的影响
- **稳定性边界图**：在参数空间中可视化稳定性区域

## 📊 主界面功能

### 数据概览
显示：
- 数据点数
- 时间范围
- 价格范围
- 基本面范围

### 反推参数结果
显示：
- α、γ、β参数值
- λ（特征值）和稳定性判断
- 拟合效果指标（R²、RMSE、MAE）

### 价格对比分析
包含4个子图：
1. **价格对比**：真实价格 vs 模型预测价格
2. **基本面对比**：真实基本面 vs 预测基本面
3. **市场预期**：展示市场预期E_t的演化
4. **价格与基本面差异**：展示P_t - F_t的差异演化

### 参数对比（如果启用手动参数）
- 左侧：反推参数及其稳定性
- 右侧：手动参数及其稳定性

### 数据下载
可以下载分析数据的CSV文件

## 💡 使用技巧

1. **首次使用**：
   - 输入股票名称（如"平安银行"）
   - 选择合适的时间范围（建议120周）
   - 点击"开始分析"按钮

2. **参数探索**：
   - 先使用反推参数，了解股票的基本特征
   - 然后启用手动参数对比，调整参数观察效果变化

3. **高级分析**：
   - 启用"参数敏感性分析"了解哪个参数对拟合效果影响最大
   - 启用"稳定性边界图"了解参数空间中哪些区域是稳定的

## 🔧 技术细节

### 数据源
- 默认使用**混合模式**（AKShare + baostock）
- 价格数据：AKShare（免费、稳定）
- 财务数据：AKShare（优先）→ baostock（备用）

### 参数反推方法
- 使用**差分进化算法**（differential_evolution）进行全局优化
- 最小化预测价格与真实价格的均方误差（MSE）

### 模型说明
反身性模型包含三个核心方程：
1. **市场认知**：E_t = α * P_t + (1-α) * F_t
2. **价格调整**：P_{t+1} = P_t + γ * (E_t - P_t) + ε_t
3. **基本面调整**：F_{t+1} = F_t + β * (P_t - F_t)

系统特征值：λ = 1 + γ(α-1) - β
- |λ| < 1：稳定收敛
- |λ| > 1：发散（泡沫或崩溃）

## ⚠️ 注意事项

1. **数据获取**：首次获取数据可能需要一些时间，数据会被缓存1小时
2. **参数反推**：参数反推是一个优化过程，可能需要几秒到几十秒
3. **网络连接**：需要网络连接以获取股票数据
4. **股票代码**：支持A股市场，输入股票名称或代码均可

## 🐛 常见问题

### Q: 数据获取失败？
A: 检查网络连接，确认股票名称或代码正确，尝试使用股票代码而非名称

### Q: 参数反推很慢？
A: 这是正常的，优化算法需要时间。可以尝试减少时间范围（周数）

### Q: 图表不显示？
A: 确保已安装plotly，检查浏览器控制台是否有错误

### Q: 参数调整后没有实时更新？
A: 调整参数后，需要重新点击"开始分析"按钮

## 📝 更新日志

### v1.0.0 (2025-11)
- ✅ 基础功能：股票数据获取、参数反推
- ✅ 参数控制：手动调整参数进行对比
- ✅ 可视化：价格对比、基本面对比、市场预期
- ✅ 高级功能：参数敏感性分析、稳定性边界图

