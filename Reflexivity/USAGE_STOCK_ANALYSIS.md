# 股票参数反推分析使用指南

## 📋 功能概述

使用真实股票数据（Tushare API获取）反推反身性模型的参数 α、β、γ。

## 🚀 快速开始

### 1. 准备工作

#### 安装依赖
```bash
pip install -r requirements.txt
```

#### 获取Tushare Token
1. 访问 https://tushare.pro/register 注册账号
2. 获取Token（详见 `tushare_guide.md`）
3. 设置环境变量：
```bash
# Windows PowerShell
$env:TUSHARE_TOKEN="your_token_here"

# Windows CMD
set TUSHARE_TOKEN=your_token_here

# Linux/Mac
export TUSHARE_TOKEN="your_token_here"
```

### 2. 运行分析

#### 基本用法（默认参数）
```bash
python analyze_stock.py
```
默认分析：平安银行，最近120周数据

#### 自定义参数
```bash
python analyze_stock.py --stock 平安银行 --weeks 120
```

#### 命令行参数
```bash
python analyze_stock.py --help
```

参数说明：
- `--stock`: 股票名称（如：平安银行、招商银行）
- `--weeks`: 回溯周数（固定窗口，默认120）
- `--token`: Tushare Token（如果不设置则从环境变量读取）
- `--output`: 结果保存目录（默认：results）

## 📊 输出结果

分析完成后，在 `results/` 目录下会生成：

1. **数据文件** (`{股票名}_data.csv`)
   - 包含日期、价格、EPS等原始数据

2. **参数结果** (`{股票名}_results.txt`)
   - 估计的参数值（α、β、γ）
   - 系统特征值 λ
   - 稳定性分析
   - 拟合效果指标（R²、RMSE等）

3. **对比图表** (`{股票名}_chart.png`)
   - 真实价格 vs 模型预测
   - 真实EPS vs 模型预测
   - 残差分析
   - 参数信息面板

4. **历史价格曲线** (`{股票名}_price_history.png`)
   - 原始历史价格走势图

## 📈 结果解读

### 参数含义

- **α (alpha)**: 价格在认知中的权重
  - 接近1：市场把价格当作基本面信号
  - >1：极端反身性，可能出现泡沫
  
- **γ (gamma)**: 价格调整速度
  - 越大：价格向预期调整越快
  
- **β (beta)**: 价格对基本面的影响
  - 越大：价格变化对基本面影响越强

### 稳定性分析

通过特征值 λ = 1 + γ(α-1) - β 判断：
- |λ| < 1：**稳定收敛** - 价格会回到基本面
- |λ| > 1：**发散** - 可能形成泡沫或崩溃
- λ < -1：**振荡发散** - 价格和基本面交替过度反应

### 拟合效果

- **R² (决定系数)**: 越接近1越好，表示模型解释能力强
- **RMSE (均方根误差)**: 越小越好，表示预测误差小
- **MAE (平均绝对误差)**: 越小越好

## 💡 使用示例

### 示例1：分析平安银行
```bash
python analyze_stock.py --stock 平安银行 --weeks 120
```

### 示例2：分析招商银行（更长历史）
```bash
python analyze_stock.py --stock 招商银行 --weeks 200
```

### 示例3：指定Token
```bash
python analyze_stock.py --stock 平安银行 --weeks 120 --token "your_token_here"
```

## 🔍 技术细节

### 数据来源
- **价格数据**: Tushare周线数据（`weekly`接口）
- **基本面数据**: Tushare财务指标（`fina_indicator`接口，EPS）
- **对齐方式**: 季度财务数据前向填充到每周

### 参数估计方法
- **优化算法**: 差分进化算法（全局优化）
- **目标函数**: 最小化价格预测的均方误差
- **参数边界**: 
  - α: [0, 2]
  - γ: [0, 5]
  - β: [0, 2]

### 数据频率
- **周频数据**：每周收盘价和EPS
- **固定窗口**：从最新时刻回溯N周

## ⚠️ 注意事项

1. **积分要求**: Tushare需要≥120积分才能获取周线和财务数据
2. **数据质量**: 
   - 停牌期间数据可能缺失
   - 财务数据按季度更新，中间使用插值
3. **参数稳定性**: 
   - 不同时间段估计的参数可能不同
   - 建议结合多个窗口的结果判断
4. **拟合精度**: 
   - R²较低时，模型可能不适合该股票
   - 可能需要考虑其他因素（市场情绪、外部冲击等）

## 🐛 常见问题

### Q1: 提示"Token未设置"
**A**: 设置环境变量 `TUSHARE_TOKEN` 或在命令中使用 `--token` 参数

### Q2: 提示"积分不足"
**A**: 需要至少120积分。可以：
- 完成实名认证
- 邀请好友
- 充值购买

### Q3: 找不到股票
**A**: 检查股票名称是否正确，或查看Tushare中的标准名称

### Q4: 数据点太少
**A**: 增加回溯周数（`--weeks`），但注意财务数据可能缺失

### Q5: 拟合效果不好（R²很低）
**A**: 可能原因：
- 该股票不适合反身性模型
- 需要更复杂的模型（非线性、多因子）
- 数据质量问题

## 📚 相关文档

- `tushare_guide.md`: Tushare注册和使用指南
- `核心需求文档.md`: 反身性模型理论文档
- `README.md`: 项目总体说明

## 🔄 下一步

- 尝试不同的股票和时间窗口
- 对比不同时期的参数变化
- 识别历史泡沫事件（λ>1的时期）
- 集成到Web应用中进行交互式分析

